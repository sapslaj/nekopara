apiVersion: operator.victoriametrics.com/v1beta1
kind: VMRule
metadata:
  name: blackbox-exporter
spec:
  groups:
    - name: blackbox-exporter
      rules:
        - alert: ProbeFailed
          expr: probe_success == 0
          for: 5m
          labels:
            severity: error
          annotations:
            summary: Probe failed (instance {{ $labels.instance }})
            description: Probe failed
        - alert: ProbeFlaky
          expr: avg_over_time(probe_success{}[5m]) < 0.5
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: Probe for instance {{ $labels.instance }} has a less than 50% success rate
            description: >-
              The probe for instance {{ $labels.instance }} is only succeeding
              {{ printf "%.1f" $value }}% of the time over the last 5 minutes
        - alert: SlowProbe
          expr: avg_over_time(probe_duration_seconds[1m]) > 3
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: Slow probe (instance {{ $labels.instance }})
            description: Blackbox probe took more than 3s to complete
        - alert: HttpStatusCode
          expr: probe_http_status_code <= 199 OR probe_http_status_code >= 400
          for: 5m
          labels:
            severity: error
          annotations:
            summary: HTTP Status Code (instance {{ $labels.instance }})
            description: HTTP status code is not 200-399
        - alert: SslCertificateWillExpireSoon
          expr: probe_ssl_earliest_cert_expiry - time() < 86400 * 30
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: SSL certificate will expire soon (instance {{ $labels.instance }})
            description: SSL certificate expires in 30 days
        - alert: SslCertificateHasExpired
          expr: probe_ssl_earliest_cert_expiry - time()  <= 0
          for: 5m
          labels:
            severity: error
          annotations:
            summary: SSL certificate has expired (instance {{ $labels.instance }})
            description: SSL certificate has expired already
        - alert: HttpSlowRequests
          expr: avg_over_time(probe_http_duration_seconds[1m]) > 3
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: HTTP slow requests (instance {{ $labels.instance }})
            description: HTTP request took more than 3s
        - alert: SlowPing
          expr: avg_over_time(probe_icmp_duration_seconds[1m]) > 3
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: Slow ping (instance {{ $labels.instance }})
            description: Blackbox ping took more than 3s
